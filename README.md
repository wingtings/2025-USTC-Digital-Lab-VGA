# FPGA VGA 实验与国际象棋游戏设计文档

## 1. 项目概览

本项目包含两个主要部分，旨在通过 FPGA 实现 VGA 显示控制及一个完整的国际象棋游戏。

![](image.png)
*   **Part 1**: VGA 显示基础实验，包含纯色显示、静态图片显示和简单的视频播放。
*   **Part 2**: 基于 VGA 显示和 PS/2 键盘输入的国际象棋游戏。

## 2. 目录结构

```text
bitstream/      # FPGA 比特流文件 (.bit)
coe/            # 存储器初始化文件 (.coe)
    Part 1/     # Part 1 实验用的图片数据
    Part2/      # Part 2 游戏用的棋子和素材数据
doc/            # 项目文档
img/            # 图片资源
Part1/          # VGA 基础实验源代码
Part2/          # 国际象棋游戏源代码
sound/          # 音频素材
```

---

## 3. Part 1: VGA 基础实验

本部分主要用于学习 VGA 时序控制和图像显示原理。

### 3.1 核心模块

*   **`DST.v` (Display Sync Timing)**: 显示时序发生器。负责产生 VGA 标准的时序信号（`hs`, `vs`）以及显示有效信号（`hen`, `ven`）。
*   **`DDP.v` (Display Data Processor)**: 显示数据处理器。根据当前的扫描坐标和输入数据，生成最终的 RGB 颜色信号。

### 3.2 顶层模块

*   **`RGB.v`**: 基础测试模块。演示如何驱动 VGA 接口显示颜色。
*   **`VGA.v`**: 静态图片显示模块。实例化 Block RAM (`VRAM`) 存储图片数据，并通过 `DDP` 模块在屏幕上显示单张静态图片。
*   **`Vedio.v`**: 视频播放模块。实例化多个存储器 IP 核，通过定时器 (`timer_cnt`) 循环切换显示的图片帧，实现简单的动画效果。

---

## 4. Part 2: 国际象棋 (Chess) 游戏设计

本部分实现了一个功能完整的双人对战国际象棋游戏。

### 4.1 系统架构

系统采用模块化设计，顶层模块 `Chess.v` 协调输入、逻辑处理、图形渲染和音频输出。

*   **`Chess.v` (Top Module)**: 顶层模块，负责时钟分频、模块实例化及信号互联。
    *   **`Keyboard.v`**: PS/2 键盘驱动与解码模块。
    *   **`Play.v`**: 核心游戏逻辑与状态机模块。
    *   **`Sound.v`**: 音频控制模块。
    *   **`DDP.v`**: 游戏画面渲染模块。
    *   **`DST.v`**: VGA 时序驱动模块。

### 4.2 模块详细说明

#### 4.2.1 顶层控制 (`Chess.v`)
*   **功能**: 系统的总入口。
*   **输入**: `clkk` (系统时钟), `rstn` (复位), `PS2_CLK`, `PS2_DATA` (键盘)。
*   **输出**: `red/green/blue` (VGA 色彩), `hs/vs` (VGA 同步), `pwm` (音频输出)。
*   **逻辑**: 处理键盘事件，将控制信号传递给 `Play` 模块，并将游戏状态传递给 `DDP` 进行渲染。

#### 4.2.2 输入系统 (`Keyboard.v`)
*   **功能**: 处理 PS/2 协议，解码扫描码并生成按键事件。
*   **按键映射**:
    *   `W`, `A`, `S`, `D`: 光标移动 (上/左/下/右)。
    *   `I`, `J`, `K`, `L`: 光标移动 (上/左/下/右)。
    *   `Space`: 选中棋子 / 确认落子。
    *   `G`: 切换升变 (Promotion) 目标棋子类型。

#### 4.2.3 核心逻辑 (`Play.v`)
*   **功能**: 维护游戏状态、棋盘数据和规则判断。
*   **状态机**:
    *   `PLAY`: 游戏进行中。
    *   `BLACK_WIN` / `WHITE_WIN`: 游戏结束状态。
*   **主要逻辑**:
    *   **棋盘表示**: 使用 `board_data` 存储 8x8 网格上的棋子信息。
    *   **规则判断**: 实现了兵、车、马、象、后、王的移动规则，以及吃子逻辑。
    *   **特殊规则**: 包含兵的升变逻辑（通过 `wanted_promotion` 控制）。
    *   **音效触发**: 根据游戏事件（移动、吃子、游戏结束）生成 `sound_code`。

#### 4.2.4 图形渲染 (`DDP.v` & `DST.v`)
*   **`DST.v`**: 产生 640x480 @ 60Hz 的 VGA 时序。
*   **`DDP.v`**: 根据 `Play.v` 提供的 `board_data`、光标位置 `cursor_x/y` 和游戏状态 `state` 进行渲染。
    *   绘制棋盘格（黑白相间）。
    *   绘制棋子（读取 Block RAM 中的 `.coe` 纹理）。
    *   绘制光标高亮框。
    *   绘制游戏结束提示或菜单。

#### 4.2.5 音效系统 (`Sound.v`)
*   **功能**: 接收 `sound_code`，通过 PWM 驱动蜂鸣器播放对应的音效（如移动声、吃子声、胜利声）。

### 4.3 操作说明

1.  **启动**: 烧录 Bitstream 后，系统启动。
2.  **移动光标**: 使用 `WASD` 或 `IJKL` 键移动棋盘上的光标框。
3.  **选中棋子**: 移动到己方棋子，按 `Space` 键选中（再次按下可取消选中）。
4.  **移动/吃子**: 选中棋子后，移动到目标位置，按 `Space` 键确认移动或吃子。
5.  **兵升变**: 当兵到达底线时，默认升变为后。按 `G` 键可以切换期望的升变类型。
6.  **游戏结束**: 当一方的王被吃掉（或满足特定胜利条件）时，游戏结束，屏幕显示获胜方。

### 4.4 其他模块
*   **`Over.v`**: 游戏结束逻辑判断模块（注：当前设计中可能已集成在 `Play.v` 中，此模块可能为独立测试或备用模块）。

## 注意事项

- 音频输出需要用AUX线接入板子上的Audio Out口。
- 本文档使用Gemini 3.0pro辅助生成，可能存在事实错误，请酌情参考。 
