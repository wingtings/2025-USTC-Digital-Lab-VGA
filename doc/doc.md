# 国际象棋 (Chess) 设计文档

## 1. 系统架构概览

本工程基于 FPGA 实现了一个 VGA 显示的国际象棋游戏。系统采用模块化设计，顶层模块协调输入、逻辑处理、图形渲染和音频输出。

### 模块层级结构

*   **`Chess.v` (Top Module)**: 顶层模块，负责时钟分频、模块实例化及信号互联。
    *   **`VGA.v`**: VGA 时序驱动模块。
    *   **`Keyboard.v`**: PS/2 键盘驱动与解码模块。
    *   **`Play.v`**: 核心游戏逻辑与状态机模块。
    *   **`DDP.v`**: 动态显示处理 (Dynamic Display Processor)，负责棋盘与棋子的渲染。
    *   **`DST.v`**: 显示状态/数据 (Display State/Data)，可能涉及背景或静态资源的渲染。
    *   **`Sound.v`**: 音频控制模块。

---

## 2. 模块详细说明

### 2.1 顶层控制 (`Chess.v`)
*   **功能**: 系统的总入口。
*   **输入**: `CLK100MHZ` (系统时钟), `PS2_CLK`, `PS2_DATA` (键盘), `RSTN` (复位)。
*   **输出**: `VGA_R/G/B` (色彩), `VGA_HS/VS` (同步信号), `AUD_PWM/SD` (音频)。
*   **逻辑**: 将键盘输入传递给游戏逻辑 (`Play`)，将游戏状态传递给渲染模块 (`DDP`, `DST`)，并将最终的 RGB 信号输出到 VGA 接口。

### 2.2 输入系统 (`Keyboard.v`)
*   **功能**: 处理 PS/2 协议，去抖动并解码扫描码。
*   **控制映射**:
    *   `W`, `A`, `S`, `D`: 光标上下左右移动。
    *   `Space` / `Enter`: 选中棋子/确认落子。
    *   `Esc`: 暂停或返回菜单。

### 2.3 核心逻辑 (`Play.v`)
此模块取代了旧文档中的 "Selector" 和分散的状态寄存器，集中管理游戏规则。
*   **状态机 (FSM)**:
    *   `MENU`: 标题界面等待开始。
    *   `PLAY`: 游戏进行中（白方回合/黑方回合）。
    *   `CHECK`: 将军状态判断。
    *   `END`: 游戏结束（将杀/和棋）。
*   **逻辑功能**:
    *   **光标管理**: 维护当前光标在 8x8 棋盘上的坐标 `(cur_x, cur_y)`。
    *   **棋盘状态**: 存储 8x8 网格上的棋子分布（类型、阵营）。
    *   **合法性判断**: 判断棋子移动是否符合规则（如马走日、象走田、兵的行进）。
    *   **交互逻辑**: 处理“选中 -> 移动 -> 吃子/落子”的流程。

### 2.4 图形渲染系统 (`VGA`, `DDP`, `DST`, `Sans`)
渲染逻辑采用分层叠加的方式，根据 VGA 扫描坐标 `(h_count, v_count)` 实时输出像素颜色。

*   **`VGA.v`**: 产生标准的 640x480 @ 60Hz (或类似分辨率) 时序信号，提供当前的像素坐标 `x, y` 和视频有效信号 `video_on`。
*   **`DDP.v` (棋盘层)**:
    *   根据 `Play.v` 提供的棋盘数据，绘制黑白格背景。
    *   根据棋子 ID，在对应格子绘制棋子图案（Pawn, Rook, Knight, Bishop, Queen, King）。
    *   绘制光标高亮框，指示当前玩家的操作位置。
*   **`DST.v` (背景/特效层)**:
    *   负责绘制游戏背景图或处理状态转换时的视觉效果。
*   **`Sans.v` (UI/文本层)**:
    *   负责绘制菜单文字（"Start Game"）。
    *   负责绘制游戏内的提示信息（如 "Checkmate", "White Wins"）。
    *   *注：命名可能源自字体名称或特定彩蛋字符。*

### 2.5 音效系统 (`Sound.v`)
*   **功能**: 接收 `Play.v` 的事件信号，通过 PWM 驱动蜂鸣器或音频输出。
*   **事件**:
    *   移动棋子 (Move)
    *   吃子/攻击 (Capture)
    *   非法操作 (Error)
    *   游戏结束 (Win/Lose)

---

## 3. 数据结构与协议

### 3.1 棋子编码 (在 `Play.v` 中维护)
为了优化存储，棋盘上的每个位置通常使用位宽较小的编码表示：
*   **位宽**: 建议 4-6 bits。
*   **定义**:
    *   最高位: 阵营 (0: 白, 1: 黑)。
    *   低位: 棋子类型 (0: 空, 1: 兵, 2: 车, 3: 马, 4: 象, 5: 后, 6: 王)。

### 3.2 渲染优先级
最终的 VGA 输出颜色由各渲染模块叠加决定，优先级通常为：
1.  **UI 层 (`Sans.v`)**: 文字、菜单最上层。
2.  **光标**: 玩家操作指示。
3.  **棋子 (`DDP.v`)**: 覆盖在棋盘上。
4.  **棋盘/背景 (`DST.v`)**: 最底层。

---

## 4. 操作说明
1.  **启动**: 烧录 Bitstream 后，进入菜单界面。
2.  **开始**: 按下 `Space` 或 `Enter` 开始游戏。
3.  **移动**: 使用 `WASD` 移动光标框。
4.  **选子**: 移动到己方棋子，按 `Space` 选中（光标变色或高亮）。
5.  **落子**: 移动到目标格，按 `Space`。
    *   